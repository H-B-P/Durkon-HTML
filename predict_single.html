<!DOCTYPE html>
<meta name="robots" content="noindex">
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Kudzu</title>
</head>
<body>
  Model: <input type="text" id="model" value="{&quot;BASE_VALUE&quot;:1000, &quot;cats&quot;:{&quot;Mackerel&quot;:{&quot;uniques&quot;:{&quot;Swedish&quot;:2.3,&quot;French&quot;:0.4},&quot;OTHER&quot;:1}}, &quot;conts&quot;:{&quot;Quality&quot;:[[0,0.2],[1,0.5],[10,1.4]]}}">
  <br>
  <br>
  <button onclick="create_inputSpace()">Request Inputs</button>
  <div id=inputSpace>
  </div>
  
  <br>
  <button onclick="predict()">Predict</button>
<br>
<br>
<br>
<div id="effects"></div>
<div id="output"></div>
  
</b>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


<script id="jsbin-javascript">

function range(r){
 return Array(r).fill(1).map((x, y) => x + y - 1)
}

leeway=0.05
defaultValue=1
targetSpan=0.5


function prep_inputSpace(model){
 if ("cats" in model){
  for (col in model["cats"]){
   console.log(col)
   
   document.getElementById("inputSpace").innerHTML += "<br>"
   document.getElementById("inputSpace").innerHTML += '<div id="plot_'+col+'"></div>'
   document.getElementById("inputSpace").innerHTML += "<br>"
   document.getElementById("inputSpace").innerHTML += '<div id="input_'+col+'"></div>'
   
  }
 }
 if ("conts" in model){
  for (col in model["conts"]){
   console.log(col)
   
   document.getElementById("inputSpace").innerHTML += "<br>"
   document.getElementById("inputSpace").innerHTML += '<div id="plot_'+col+'"></div>'
   document.getElementById("inputSpace").innerHTML += "<br>"
   document.getElementById("inputSpace").innerHTML += '<div id="input_'+col+'"></div>'
  }
 }
}

function create_inputSpace(){
 model = document.getElementById("model").value
 model = JSON.parse(model)
 document.getElementById("inputSpace").innerHTML = ""
 prep_inputSpace(model)//.then(function(){
	 
	 
	 if ("cats" in model){
	  for (col in model["cats"]){
	   console.log(col)
	   
	   //document.getElementById("inputSpace").innerHTML += "<br>"
	   //document.getElementById("inputSpace").innerHTML += '<div id="plot_'+col+'"></div>'
	   
	   var xList = []
	   var yList = []
	   
	   for (k in model["cats"][col]["uniques"]){
	    xList.push(k)
	    yList.push(model["cats"][col]["uniques"][k])
	   }
	   if (model["cats"][col].hasOwnProperty("OTHER")){
	    xList.push("OTHER")
	    yList.push(model["cats"][col]["OTHER"])
	   }
	   
	   var plotdata = [
	   {
	    x: xList,
	    y: yList,
	    type: 'bar'
	   }
	   ]
	   
	   var layout = {
	   title: 'PDP for '+col,
	   xaxis: {
	    title: col,
	   },
	   yaxis: {
	    title: 'Multiplier',
	    range: [Math.min(Math.min(...yList)-leeway, 0, defaultValue-targetSpan), Math.max(Math.max(...yList)+leeway, defaultValue+targetSpan)]
	   },
	   
	   height: 600,
	   width: 800
	   };
	   
	   Plotly.newPlot("plot_"+col, plotdata, layout)
	   
	   //Plotly.toImage("plot_"+col, {format: 'png', width: 600, height: 400}).then(function(url){
	   // console.log("hurgus")
	   // document.getElementById("inputSpace").innerHTML += '<img src="'+url+'">'
	   // console.log("burgus")
	   //})
	   
	   //document.getElementById("plot_"+col).innerHTML = ""
	   
	   
	   document.getElementById("input_"+col).innerHTML += ""+col
	   document.getElementById("input_"+col).innerHTML += ': <input type="text" id="dat_'+col+'">'
	  }
	 }
	 if ("conts" in model){
	  for (col in model["conts"]){
	   console.log(col)
	   //document.getElementById("inputSpace").innerHTML += "<br>"
	   //document.getElementById("inputSpace").innerHTML += '<div id="plot_'+col+'" style="z-index: 9999;"></div>'
	   
	   
	   var xList = []
	   var yList = []
	   
	   for (k in model["conts"][col]){
	    xList.push(model["conts"][col][k][0])
	    yList.push(model["conts"][col][k][1])
	   }
	   
	   
	   var plotdata = [
	   {
	    x: xList,
	    y: yList,
	    type: 'scatter',
	    mode: 'lines+markers'
	   }
	   ]
	   
	   var layout = {
	   title: 'PDP for '+col,
	   xaxis: {
	    title: col,
	   },
	   yaxis: {
	    title: 'Multiplier',
	    range: [Math.min(Math.min(...yList)-leeway, defaultValue-targetSpan), Math.max(Math.max(...yList)+leeway, defaultValue+targetSpan)]
	   },
	   
	   height: 600,
	   width: 800
	   };
	   
	   Plotly.newPlot("plot_"+col, plotdata, layout)
	   //Plotly.toImage("plot_"+col, {format: 'png', width: 600, height: 400}).then(function(url){
	   // document.getElementById("inputSpace").innerHTML += '<img src="'+url+'">'
	   //})
	   
	   
	   //document.getElementById("plot_"+col).innerHTML = ""
	   
	   document.getElementById("input_"+col).innerHTML += ""+col
	   document.getElementById("input_"+col).innerHTML += ': <input type="number" id="dat_'+col+'">'
	  }
	 }
 //})
 //console.log(document.getElementById("inputSpace").innerHTML)
}

function predict() {
 model = document.getElementById("model").value
 model = JSON.parse(model)
 console.log('m',model)
 ipd = {}
 console.log(document.getElementById("inputSpace").innerHTML)
 if ("cats" in model){
  for (col in model["cats"]){
   ipd[col] = document.getElementById("dat_"+col).value
  }
 }
 if ("conts" in model){
  for (col in model["conts"]){
   ipd[col] = parseFloat(document.getElementById("dat_"+col).value)
  }
 }
 console.log(ipd)
 p = predict_mult_flashily(model, ipd)
 
 document.getElementById("output").innerHTML = Math.round(p*100)/100
 console.log('p',p)
}

function predict_mult(model, inputDict) {
 pred = model["BASE_VALUE"]
 if ("cats" in model){
  for (col in model["cats"]){
   effectOfCol = get_effect_of_cat_on_single_input(inputDict[col], model['cats'][col])
   console.log(effectOfCol)
   pred = pred*effectOfCol
  }
 }
 if ("conts" in model){
  for (col in model["conts"]){
   effectOfCol = get_effect_of_cont_on_single_input(inputDict[col], model['conts'][col])
   console.log(effectOfCol)
   pred = pred*effectOfCol
  }
 }
 return pred
}

function predict_mult_flashily(model, inputDict) {
 pred = model["BASE_VALUE"]
 
 document.getElementById("effects").innerHTML = ""+model["BASE_VALUE"]+ " * "
 
 if ("cats" in model){
  for (col in model["cats"]){
   
   effectOfCol = get_effect_of_cat_on_single_input(inputDict[col], model['cats'][col])
   
   document.getElementById("effects").innerHTML += (""+(Math.round(effectOfCol*10000)/10000)+" * ")
   
   
   var xList = []
   var yList = []
   
   if (inputDict[col] in model['cats'][col]["uniques"]){
    xOfCol = inputDict[col]
   }
   else{
    xOfCol = "OTHER"
   }
   
   
   for (k in model["cats"][col]["uniques"]){
    xList.push(k)
    yList.push(model["cats"][col]["uniques"][k])
   }
   if (model["cats"][col].hasOwnProperty("OTHER")){
    xList.push("OTHER")
    yList.push(model["cats"][col]["OTHER"])
   }
   
   var plotdata = [
   {
    x: xList,
    y: yList,
    type: 'bar',
    name: 'Multipliers'
   },
   {
    x:[xOfCol],
    y:[effectOfCol],
    type: 'scatter',
    mode: 'markers',
    name: 'Effect on prediction',
    marker: {
      color: 'red',
      symbol: 'square',
      size: 10
    }
   }
   ]
   
   var layout = {
   title: 'PDP for '+col,
   xaxis: {
    title: col,
   },
   yaxis: {
    title: 'Multiplier',
    range: [Math.min(Math.min(...yList)-leeway, 0, defaultValue-targetSpan), Math.max(Math.max(...yList)+leeway, defaultValue+targetSpan)]
   },
   
   height: 600,
   width: 800
   };
   
   Plotly.react("plot_"+col, plotdata, layout)
   
   console.log(effectOfCol)
   pred = pred*effectOfCol
  }
 }
 if ("conts" in model){
  for (col in model["conts"]){
   
   effectOfCol = get_effect_of_cont_on_single_input(inputDict[col], model['conts'][col])
   
   document.getElementById("effects").innerHTML += (""+(Math.round(effectOfCol*10000)/10000)+" * ")
   
   console.log(effectOfCol)
   
   var xList = []
   var yList = []
   
   for (k in model["conts"][col]){
    xList.push(model["conts"][col][k][0])
    yList.push(model["conts"][col][k][1])
   }
   
   var plotdata = [
   {
    x: xList,
    y: yList,
    type: 'scatter',
    mode: 'lines+markers',
    name: 'Multipliers'
   },
   {
    x:[inputDict[col]],
    y:[effectOfCol],
    type: 'scatter',
    mode: 'markers',
    name: 'Effect on prediction',
    marker: {
      color: 'red',
      symbol: 'square',
      size: 10
    }
   }
   ]
   
   var layout = {
	   title: 'PDP for '+col,
	   xaxis: {
	    title: col,
	   },
	   yaxis: {
	    title: 'Multiplier',
	    range: [Math.min(Math.min(...yList)-leeway, defaultValue-targetSpan), Math.max(Math.max(...yList)+leeway, defaultValue+targetSpan)]
	   },
	   
	   height: 600,
	   width: 800
	   };
   
   Plotly.react("plot_"+col, plotdata, layout)
   
   pred = pred*effectOfCol
  }
 }
 
 document.getElementById("effects").innerHTML = document.getElementById("effects").innerHTML.slice(0,-3) + " = "
 
 return pred
}

function get_effect_of_cat_on_single_input(input,cat){
 if (input in cat["uniques"]){
  return cat["uniques"][input]
 }
 return cat["OTHER"]
}

function get_effect_of_cont_on_single_input(x, cont){
 console.log(cont,x)
 if (x<=cont[0][0]){
  return cont[0][1]} //everything outside our scope is flat
 for (var i = 0; i < (cont.length-1); i++){
  console.log(cont[i], cont[i+1])
  if (x>=cont[i][0] && x<=cont[i+1][0]){
   return ((x-cont[i][0])*cont[i+1][1] + (cont[i+1][0]-x)*cont[i][1])/(cont[i+1][0]-cont[i][0])}} //((x-p1)y1 + (p2-x)y2) / (p2 - p1)
 if (x>=cont[cont.length-1][0]){
  return cont[cont.length-1][1] //everything outside our scope is flat
 }
}

</script>
</body>
</html>
